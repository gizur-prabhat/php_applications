<!DOCTYPE html>  <html> <head>   <title>test_cronjob1.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="ftp.html">                 ftp.js               </a>                                           <a class="source" href="grunt.html">                 grunt.js               </a>                                           <a class="source" href="init.html">                 init.js               </a>                                           <a class="source" href="make.html">                 make.js               </a>                                           <a class="source" href="test_cronjob1.html">                 test_cronjob1.js               </a>                                           <a class="source" href="test_cronjob2.html">                 test_cronjob2.js               </a>                                           <a class="source" href="test_cronjob3.html">                 test_cronjob3.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               test_cronjob1.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>
</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <hr />

<p>2013-03-08, Prabhat Khera</p>

<p>Copyright Gizur AB 2012</p>

<p>Functions:
 * Test jobs cron-style</p>

<p>Install with dependencies: npm install </p>

<p>Documentation is 'docco style' - http://jashkenas.github.com/docco/</p>

<p>Using Google JavaScript Style Guide - 
http://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml</p>

<hr />             </td>             <td class="code">               <div class="highlight"><pre>

<span class="string">"use strict"</span>;


</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h1>Includes</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">var</span> AWS = require(<span class="string">'aws-sdk'</span>);
<span class="keyword">var</span> mysql = require(<span class="string">"mysql"</span>);
<span class="keyword">var</span> http    = require(<span class="string">'http'</span>);
<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> exec = require(<span class="string">'child_process'</span>).exec;

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h1>Configs</h1>

<p>Load / read the AWS credentials</p>             </td>             <td class="code">               <div class="highlight"><pre>AWS.config.loadFromPath(<span class="string">'./_secure/credentials.json'</span>);

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Load the configurations</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">var</span> config  = require(<span class="string">'./_secure/config.js'</span>).Config;

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>If server requires secure connection
use https</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">if</span>(config.IS_HTTPS)
    http = require(<span class="string">'https'</span>);

</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Connection to vtiger MySQL db</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">var</span> connection = mysql.createConnection({
    host: config.DB_HOST,
    user: config.DB_USER,
    password: config.DB_PASSWORD,
    database: config.DB_NAME
});

</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Connection to integration MySQL db</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">var</span> int_connection = mysql.createConnection({
    host: config.DB_I_HOST,
    user: config.DB_I_USER,
    password: config.DB_I_PASSWORD,
    database: config.DB_I_NAME
});

</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h4>Connect with the databases.</h4>             </td>             <td class="code">               <div class="highlight"><pre>connection.connect();
int_connection.connect();

</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h1>Expected test results</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">var</span> salesOrdervTigerBefore = <span class="number">1</span>,
salesOrderIntegrationBefore = <span class="number">0</span>,
salesOrdervTigerAfter = <span class="number">0</span>,
salesOrderIntegrationAfter = <span class="number">1</span>;
    
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h1>Group all Tests</h1>

<p>Before excuting this script,
Edit test cases for the expected value.</p>             </td>             <td class="code">               <div class="highlight"><pre>exports.group = {
</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h4>Check sales orders in vtiger before hitting cron job 1</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Checking Sales Orders in vTiger ('Created','Approved') before hitting cron job 1"</span> : <span class="keyword">function</span>(test){
        connection.query(<span class="string">"SELECT SO.salesorderid, SO.salesorder_no FROM "</span> +
            <span class="string">"vtiger_salesorder SO "</span> + 
            <span class="string">"WHERE SO.sostatus IN ('Created','Approved') "</span> +
            <span class="string">"LIMIT 0, 10"</span>, <span class="keyword">function</span>(err, rows, fields) {
                <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;
                
                <span class="keyword">var</span> result = <span class="literal">false</span>;
                <span class="keyword">if</span>(rows.length == salesOrdervTigerBefore)
                    result = <span class="literal">true</span>;
                
                test.ok(result, salesOrdervTigerBefore + <span class="string">" sales orders expected, "</span> + rows.length + <span class="string">" found."</span>);
                test.done();
            });
    },
</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h4>Check sales orders in integration db before hitting cron job 1</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Checking Sales Order In Integration Database before hitting Cron job 1"</span> : <span class="keyword">function</span>(test){
        int_connection.query(<span class="string">"SELECT salesorder_no, "</span> +
            <span class="string">"accountname "</span> +
            <span class="string">"FROM salesorder_interface "</span> +
            <span class="string">"WHERE sostatus IN ('created', 'approved') "</span> +
            <span class="string">"GROUP BY salesorder_no, accountname"</span>, <span class="keyword">function</span>(err, rows, fields) {
                <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;
                
                <span class="keyword">var</span> result = <span class="literal">false</span>;
                <span class="keyword">if</span>(rows.length == salesOrderIntegrationBefore)
                    result = <span class="literal">true</span>;
                
                test.ok(result, salesOrderIntegrationBefore + <span class="string">" sales orders expected, "</span> + rows.length + <span class="string">" found."</span>);
                test.done();
            });
    },
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h4>Hit cron job 1</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Hitting Cron Job 1"</span> : <span class="keyword">function</span>(test){
        exec(<span class="string">"chmod +x "</span> + config.PHP_BATCHES_1, <span class="function"><span class="keyword">function</span> <span class="params">(error, stdout, stderr)</span> {</span>
            <span class="keyword">if</span> (error !== <span class="literal">null</span>)
                console.log(<span class="string">"Error in chmod +x "</span> + config.PHP_BATCHES_1);
            <span class="keyword">else</span>{
                exec(config.PHP_BATCHES_1, <span class="function"><span class="keyword">function</span> <span class="params">(error, stdout, stderr)</span> {</span>
                    <span class="keyword">if</span> (error !== <span class="literal">null</span>){
                        test.ok(<span class="literal">false</span>, <span class="string">"Error executing "</span> + config.PHP_BATCHES_1);
                        test.done();
                    }<span class="keyword">else</span>{
                        test.ok(<span class="literal">true</span>, <span class="string">"Executed : "</span> + config.PHP_BATCHES_1 + <span class="string">" : "</span> + stdout);
                        test.done();
                    }
                });
            }
        });
    },
</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h4>Check sales orders in vtiger after hitting cron job 2</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Checking Sales Orders in vTiger ('Created','Approved') after hitting cron job 1"</span> : <span class="keyword">function</span>(test){
        connection.query(<span class="string">"SELECT SO.salesorderid, SO.salesorder_no FROM "</span> +
            <span class="string">"vtiger_salesorder SO "</span> + 
            <span class="string">"WHERE SO.sostatus IN ('Created','Approved') "</span> +
            <span class="string">"LIMIT 0, 10"</span>, <span class="keyword">function</span>(err, rows, fields) {
                <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;
                
                <span class="keyword">var</span> result = <span class="literal">false</span>;
                <span class="keyword">if</span>(rows.length == salesOrdervTigerAfter)
                    result = <span class="literal">true</span>;
                
                test.ok(result, salesOrdervTigerAfter + <span class="string">" sales orders expected, "</span> + rows.length + <span class="string">" found."</span>);
                test.done();
            });
    },
</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h4>Check sales orders in integration db after hitting cron job 1</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Checking Sales Order In Integration Database"</span> : <span class="keyword">function</span>(test){
        int_connection.query(<span class="string">"SELECT salesorder_no, "</span> +
            <span class="string">"accountname "</span> +
            <span class="string">"FROM salesorder_interface "</span> +
            <span class="string">"WHERE sostatus IN ('created', 'approved') "</span> +
            <span class="string">"GROUP BY salesorder_no, accountname"</span>, <span class="keyword">function</span>(err, rows, fields) {
                <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;
                
                <span class="keyword">var</span> result = <span class="literal">false</span>;
                <span class="keyword">if</span>(rows.length == salesOrderIntegrationAfter)
                    result = <span class="literal">true</span>;
                
                test.ok(result, salesOrderIntegrationAfter + <span class="string">" sales orders expected, "</span> + rows.length + <span class="string">" found."</span>);
                test.done();
            });
    },
</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h4>Closing connections</h4>

<p>Reason behind putting closing connections in
a test is, not to close db connections
before all tests get finished.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Closing Connections"</span> : <span class="keyword">function</span>(test){
        connection.destroy();
        int_connection.destroy();
        test.ok(<span class="literal">true</span>, <span class="string">"Connections closed."</span>);
        test.done();
    }
};
</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 