<!DOCTYPE html>  <html> <head>   <title>test_cronjob3.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="ftp.html">                 ftp.js               </a>                                           <a class="source" href="grunt.html">                 grunt.js               </a>                                           <a class="source" href="init.html">                 init.js               </a>                                           <a class="source" href="make.html">                 make.js               </a>                                           <a class="source" href="test_cronjob1.html">                 test_cronjob1.js               </a>                                           <a class="source" href="test_cronjob2.html">                 test_cronjob2.js               </a>                                           <a class="source" href="test_cronjob3.html">                 test_cronjob3.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               test_cronjob3.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre>
</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <hr />

<p>2013-03-08, Prabhat Khera</p>

<p>Copyright Gizur AB 2012</p>

<p>Functions:
 * Test jobs cron-style</p>

<p>Install with dependencies: npm install </p>

<p>Documentation is 'docco style' - http://jashkenas.github.com/docco/</p>

<p>Using Google JavaScript Style Guide - 
http://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml</p>

<hr />             </td>             <td class="code">               <div class="highlight"><pre>

<span class="string">"use strict"</span>;


</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h1>Includes</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">var</span> AWS = require(<span class="string">'aws-sdk'</span>);
<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> exec = require(<span class="string">'child_process'</span>).exec;

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h1>Configs</h1>

<p>Load / read the AWS credentials</p>             </td>             <td class="code">               <div class="highlight"><pre>AWS.config.loadFromPath(<span class="string">'./_secure/credentials.json'</span>);

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Load the configurations</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="keyword">var</span> config  = require(<span class="string">'./_secure/config.js'</span>).Config;

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h1>Configure Expected Test Result</h1>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="keyword">var</span> messagesInQueueBefore = <span class="number">0</span>, 
messagesInQueueAfter = <span class="number">0</span>,
fileInFTPBefore = <span class="number">3</span>,
fileInFTPAfter = <span class="number">3</span>;
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h1>Group all Tests</h1>             </td>             <td class="code">               <div class="highlight"><pre>exports.group = {
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h4>Check Queue before hitting cron job 3</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Checking SQS for messages before hitting Cron job 3"</span> : <span class="keyword">function</span>(test){
        <span class="keyword">var</span> sqs = <span class="keyword">new</span> AWS.SQS();
        <span class="keyword">var</span> params = {
            QueueUrl: config.Q_URL,
            AttributeNames: <span class="keyword">new</span> Array(<span class="string">'All'</span>)
        };
        sqs.client.getQueueAttributes(params, <span class="keyword">function</span>(err, data) {
            <span class="keyword">if</span> (!err) {
                <span class="keyword">var</span> result = <span class="literal">false</span>;
                <span class="keyword">var</span> cnt = data.Attributes.ApproximateNumberOfMessages;
                <span class="keyword">if</span>(cnt == messagesInQueueBefore)
                    result = <span class="literal">true</span>;
                
                test.ok(result, messagesInQueueBefore + <span class="string">" messages expected, "</span> + cnt + <span class="string">" found."</span>);
                test.done();
            }<span class="keyword">else</span>{
                test.ok(<span class="literal">false</span>, <span class="string">"Failed due to error : "</span> + err);
                test.done();
            }            
        });
    },
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h4>Check files before hitting cron job 3</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Checking Files at FTP before hitting Cron job 3"</span> : <span class="keyword">function</span>(test){
        fs.readdir(config.LOCAL_FTP_FOLDER, <span class="keyword">function</span>(err, stats){
            <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;
            <span class="keyword">var</span> result = <span class="literal">false</span>;
            <span class="keyword">var</span> cnt = stats.length;
            <span class="keyword">if</span>(cnt == fileInFTPBefore)
                result = <span class="literal">true</span>;
            test.ok(result, fileInFTPAfter + <span class="string">" expected but found "</span> + cnt + <span class="string">" at "</span> + config.LOCAL_FTP_FOLDER);
            test.done();
        });
    },
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h4>Hit Cron Job 3</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Hitting Cron Job 3"</span> : <span class="keyword">function</span>(test){
        exec(<span class="string">"chmod +x "</span> + config.PHP_BATCHES_3, <span class="function"><span class="keyword">function</span> <span class="params">(error, stdout, stderr)</span> {</span>
            <span class="keyword">if</span> (error !== <span class="literal">null</span>)
                console.log(<span class="string">"Error in chmod +x "</span> + config.PHP_BATCHES_3);
            <span class="keyword">else</span>{
                exec(config.PHP_BATCHES_3, <span class="function"><span class="keyword">function</span> <span class="params">(error, stdout, stderr)</span> {</span>
                    <span class="keyword">if</span> (error !== <span class="literal">null</span>){
                        test.ok(<span class="literal">false</span>, <span class="string">"Error executing "</span> + config.PHP_BATCHES_3);
                        test.done();
                    }<span class="keyword">else</span>{
                        test.ok(<span class="literal">true</span>, <span class="string">"Executed : "</span> + config.PHP_BATCHES_3 + <span class="string">" : "</span> + stdout);
                        test.done();
                    }
                });
            }
        });
    },
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h4>Check SQS messages after hitting cron job 3</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Checking SQS for messages after hitting Cron job 3"</span> : <span class="keyword">function</span>(test){
        <span class="keyword">var</span> sqs = <span class="keyword">new</span> AWS.SQS();
        <span class="keyword">var</span> params = {
            QueueUrl: config.Q_URL,
            AttributeNames: <span class="keyword">new</span> Array(<span class="string">'All'</span>)
        };
        sqs.client.getQueueAttributes(params, <span class="keyword">function</span>(err, data) {
            <span class="keyword">if</span> (!err) {
                
                <span class="keyword">var</span> result = <span class="literal">false</span>;
                <span class="keyword">var</span> cnt = data.Attributes.ApproximateNumberOfMessages;
                <span class="keyword">if</span>(cnt == messagesInQueueAfter)
                    result = <span class="literal">true</span>;
                
                test.ok(result, messagesInQueueAfter + <span class="string">" messages expected, "</span> + cnt + <span class="string">" found."</span>);
                test.done();
            }<span class="keyword">else</span>{
                test.ok(<span class="literal">false</span>, <span class="string">"Failed due to error : "</span> + err);
                test.done();
            }            
        });
    },
</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h4>Check SQS messages after hitting cron job 3</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="string">"Checking Files at FTP after hitting Cron job 3"</span> : <span class="keyword">function</span>(test){
        fs.readdir(config.LOCAL_FTP_FOLDER, <span class="keyword">function</span>(err, stats){
            <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;
            <span class="keyword">var</span> result = <span class="literal">false</span>;
            <span class="keyword">var</span> cnt = stats.length;
            <span class="keyword">if</span>(cnt == fileInFTPAfter)
                result = <span class="literal">true</span>;
            test.ok(result, fileInFTPAfter + <span class="string">" expected but found "</span> + cnt + <span class="string">" at "</span> + config.LOCAL_FTP_FOLDER);
            test.done();
        });
    }
};
</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 